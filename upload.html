<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Upload karya dan analisis AI untuk portofolio Rangga Abi Yasha.">
  <title>Upload & Analisis — Portofolio</title>

  <!-- Font: Space Mono -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-dark:#0b0f14;
      --panel:#0f1728;
      --muted:#9aa4b2;
      --accent:#ff9800; /* oranye */
      --glass: rgba(255,255,255,0.03);
      --accent-glow: 0 10px 30px rgba(255,152,0,0.08);
      --maxw:1200px;
      --mono: 'Space Mono', monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:var(--mono), monospace;background:linear-gradient(180deg,#080b10 0%, #05070a 100%);color:#eaf3fb;-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}

    /* Header */
    header{
      position:sticky;top:0;z-index:60;
      backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(15,17,32,0.8), rgba(15,17,32,0.45));
      border-bottom: 1px solid rgba(255,255,255,0.03);
      box-shadow: 0 6px 24px rgba(0,0,0,0.6);
    }
    nav{max-width:var(--maxw);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:0.85rem 1rem}
    nav h1{font-size:1rem;color:var(--accent);margin:0}
    .nav-right{display:flex;align-items:center;gap:1rem}
    .nav-links{display:flex;gap:14px;align-items:center}
    .nav-links a{padding:8px 10px;border-radius:8px;text-decoration:none;color:var(--muted);font-weight:700;font-size:0.95rem}
    .nav-links a.active, .nav-links a:hover{background:var(--glass);color:var(--accent)}

    /* container */
    .container{max-width:var(--maxw);margin:0 auto;padding:0 1rem}

    /* Main content */
    main{padding:3rem 2rem}
    .upload-card{background:linear-gradient(180deg,var(--panel), #07101a);padding:2rem;border-radius:14px;border:1px solid rgba(255,255,255,0.02);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .upload-card h1{color:#fff;margin:0 0 1rem;font-size:2rem}
    .upload-card p{color:var(--muted);margin:0 0 1.5rem;line-height:1.6}

    /* Overlay for drag & drop */
    #dragOverlay{position:fixed;inset:0;background:rgba(255,152,0,0.2);border:4px dashed var(--accent);z-index:9998;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .3s}
    #dragOverlay.visible{opacity:1}
    #dragOverlay h2{color:#fff;font-size:2rem;text-shadow:0 2px 10px rgba(0,0,0,0.5)}

    label{display:block;margin-top:1rem;font-weight:700;color:#fff}
    input[type=file], select, input[type=number], textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#eaf3fb;font-family:var(--mono)}
    textarea{min-height:120px}

    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .col{flex:1;min-width:160px}

    button{margin-top:1.5rem;padding:12px 20px;border-radius:999px;border:none;background:var(--accent);color:#071019;text-decoration:none;font-weight:800;box-shadow:var(--accent-glow);transition:transform .2s,box-shadow .2s;cursor:pointer}
    button:hover{transform:translateY(-4px);box-shadow:0 18px 40px rgba(255,152,0,0.16)}

    .preview{margin-top:1rem;max-width:360px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);overflow:hidden}
    img.preview-img{width:100%;display:block}

    .analysis{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;margin-top:1rem;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    td, th{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.05);text-align:left}

    .small{font-size:0.9rem;color:var(--muted)}
    .success{background:linear-gradient(90deg,#00b74a,#00ff66);padding:10px;border-radius:8px;color:#021;display:inline-block;margin-top:12px;font-weight:700}

    /* Improved layout for upload and analysis sections */
    .upload-section, .analysis-section { margin-bottom: 2rem; }
    .upload-section h3, .analysis-section h3 { color: var(--accent); margin-bottom: 1rem; font-size: 1.2rem; }
    .upload-section .form-group { margin-bottom: 1.5rem; }
    .analysis-section .ai-result { background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; margin-top: 1rem; }
    .manual-scores { background: rgba(255,255,255,0.02); padding: 1rem; border-radius: 8px; margin-top: 1rem; }
    .manual-scores h4 { color: var(--accent); margin-bottom: 0.5rem; }
    .contribution-info { background: rgba(255,255,255,0.02); padding: 1rem; border-radius: 8px; margin-top: 1rem; }
    .contribution-info p { margin: 0; }

    /* Login section styles */
    .login-section { background: rgba(255,255,255,0.02); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; transition: opacity 0.5s ease, transform 0.5s ease; }
    .login-section h3 { color: var(--accent); margin-bottom: 1rem; font-size: 1.2rem; }
    .login-section .form-group { margin-bottom: 1rem; }
    .login-section input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.03); background: transparent; color: #eaf3fb; font-family: var(--mono); transition: border-color 0.3s ease; }
    .login-section input:focus { border-color: var(--accent); outline: none; }
    .login-section label { display: block; margin-bottom: 0.5rem; font-weight: 700; color: #fff; }

    /* Upload content fade-in */
    #uploadContent { opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease, transform 0.5s ease; }
    #uploadContent.show { opacity: 1; transform: translateY(0); }

    /* Drag and drop styles */
    .drop-zone { position: relative; display: inline-block; width: 100%; }
    .drop-zone.dragover label { background: rgba(255,152,0,0.1); border-color: var(--accent); }

    /* Loading spinner */
    .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--accent); animation: spin 1s ease-in-out infinite; margin-right: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Button enhancements */
    button:hover { transform: translateY(-2px); box-shadow: 0 12px 30px rgba(255,152,0,0.2); }
    button:active { transform: translateY(0); }

    /* Input hover effects */
    input:hover, textarea:hover { border-color: rgba(255,255,255,0.1); }

    /* Tooltip styles */
    .tooltip { position: relative; display: inline-block; }
    .tooltip .tooltiptext { visibility: hidden; width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 0.8rem; }
    .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

    /* Success/error message animations */
    .message { animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* Responsive tweaks */
    @media (max-width: 768px) { .row { flex-direction: column; } .col { margin-bottom: 1rem; } }
  </style>
</head>
<body>

  <header>
    <nav>
      <h1>Rangga Abi Yasha — 3D Artist</h1>
      <div class="nav-right">
        <div class="nav-links">
          <a href="index.html">Home</a>
          <a href="index.html#SkillAplikasi">Skills</a>
          <a href="index.html#Portofoliodigital">Portfolio</a>
          <a href="index.html#GalleryArt">Gallery</a>
          <a href="upload.html" class="active">Upload</a>
          <a href="index.html#Contact">Contact</a>
        </div>
      </div>
    </nav>
  </header>

  <div id="dragOverlay">
    <h2>Letakkan file di mana saja untuk mengunggah</h2>
  </div>


  <main class="container">
    <div class="upload-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
        <h1>Upload & Analisis Proyek</h1>
        <a href="index.html" class="btn" style="padding:8px 16px;font-size:0.9rem">← Kembali ke Home</a>
      </div>
      <p>Upload gambar hasil karya, isi deskripsi teknik yang digunakan, pilih aplikasi tujuan. Sistem akan menganalisis secara otomatis (AI sederhana + analisis gambar) dan kamu bisa beri skor manual. Hasil akhir adalah gabungan skor user & AI (50:50), lalu disimpan ke halaman aplikasi terkait.</p>

      <!-- Login Section -->
      <div id="loginSection" class="login-section">
        <h3>Login untuk Upload</h3>
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" placeholder="Masukkan username">
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Masukkan password">
        </div>
        <button id="loginBtn">Login</button>
        <div id="loginError" style="color:#f99;margin-top:10px;display:none">Username atau password salah.</div>
      </div>

      <div id="uploadContent" style="display:none">
      <div class="upload-section">
        <h3>1) Pilih aplikasi tujuan</h3>
        <div class="form-group">
          <select id="appSelect">
            <option value="blender">Blender</option>
            <option value="zbrush">ZBrush</option>
            <option value="substance">Substance Painter</option>
            <option value="photoshop">Photoshop</option>
            <option value="illustrator">Illustrator</option>
            <option value="premiere">Premiere Pro</option>
            <option value="fotogrfi">Photography</option>
            <option value="digitalart">Digital Art</option>
        <option value="aftereffects">After Effects</option>
        <option value="traditionalart">Traditional Art</option>
          </select>
        </div>

        <h3>2) Upload gambar hasil render</h3>
        <div class="form-group">
          <div class="drop-zone">
            <input id="fileInput" type="file" accept="image/*,video/mp4" style="position:absolute;left:-9999px">
            <label for="fileInput" style="display:block;padding:12px;border-radius:8px;border:2px dashed rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:var(--muted);text-align:center;cursor:pointer;transition:background 0.2s">Klik untuk pilih gambar/video atau drag & drop di sini</label>
          </div>
          <div class="preview" id="previewWrap" style="display:none">
            <img id="previewImg" class="preview-img" src="" alt="preview">
            <video id="previewVideo" class="preview-img" controls muted style="display:none;"></video>
          </div>
        </div>

        <h3>3) Deskripsi proyek (tulis teknik yang kamu pakai)</h3>
        <div class="form-group">
          <textarea id="desc" placeholder="Contoh: blockout -> sculpt -> retopo -> UV -> HDRI lighting, bevel modifier, subsurface scattering..."></textarea>
        </div>
      </div>

      <div class="analysis-section">
        <h3>4) Analisis AI</h3>
        <button id="analyzeBtn">Analisis AI</button>
        <div id="aiResult" class="analysis ai-result" style="display:none"></div>
      </div>

      <div class="manual-scores">
        <h4>5) Nilai manual (0–10)</h4>
        <div class="row" id="manualScores">
          <div class="col">
            <label id="label_modeling">Modeling</label><input id="u_modeling" type="number" min="0" max="10" step="0.1" value="7">
          </div>
          <div class="col">
            <label id="label_lighting">Lighting</label><input id="u_lighting" type="number" min="0" max="10" step="0.1" value="7">
          </div>
          <div class="col">
            <label id="label_texturing">Texturing & Material</label><input id="u_texturing" type="number" min="0" max="10" step="0.1" value="7">
          </div>
          <div class="col">
            <label id="label_rendering">Rendering</label><input id="u_rendering" type="number" min="0" max="10" step="0.1" value="7">
          </div>
          <div class="col">
            <label id="label_deskripsi">Deskripsi Teknis</label><input id="u_deskripsi" type="number" min="0" max="10" step="0.1" value="7">
          </div>
        </div>
      </div>

      <div class="contribution-info">
        <h4>6) Kontribusi nilai akhir</h4>
        <p class="small">User : AI = <strong>50 : 50</strong> (fixed sesuai permintaan)</p>
      </div>

      <button id="finalizeBtn">Finalize & Upload ke Halaman Aplikasi</button>

      <div id="status" style="margin-top:10px"></div>
    </div>

  <script>
    // Konfigurasi bobot aspek
    const ASPECT_WEIGHTS = {
      modeling: 30,
      lighting: 15,
      texturing: 25,
      rendering: 15,
      deskripsi: 15
    };

    // Dynamic labels per app
    const APP_LABELS = {
      blender: {
        modeling: 'Modeling',
        lighting: 'Lighting',
        texturing: 'Texturing & Material',
        rendering: 'Rendering',
        deskripsi: 'Deskripsi Teknis'
      },
      zbrush: {
        modeling: 'Sculpting',
        lighting: 'Lighting',
        texturing: 'Texturing & Material',
        rendering: 'Rendering',
        deskripsi: 'Deskripsi Teknis'
      },
      substance: {
        modeling: 'Modeling',
        lighting: 'Lighting',
        texturing: 'Texturing & Material',
        rendering: 'Rendering',
        deskripsi: 'Deskripsi Teknis'
      },
      photoshop: {
        modeling: 'Composition',
        lighting: 'Lighting',
        texturing: 'Effects',
        rendering: 'Export',
        deskripsi: 'Deskripsi Teknis'
      },
      illustrator: {
        modeling: 'Layout',
        lighting: 'Color',
        texturing: 'Styling',
        rendering: 'Export',
        deskripsi: 'Deskripsi Teknis'
      },
      premiere: {
        modeling: 'Editing',
        lighting: 'Color Grading',
        texturing: 'Effects',
        rendering: 'Export',
        deskripsi: 'Deskripsi Teknis'
      },
      fotogrfi: {
        modeling: 'Composition',
        lighting: 'Lighting',
        texturing: 'Editing',
        rendering: 'Post-Processing',
        deskripsi: 'Deskripsi Teknis'
      },
      digitalart: {
        modeling: 'Concept',
        lighting: 'Color',
        texturing: 'Styling',
        rendering: 'Export',
        deskripsi: 'Deskripsi Teknis'
      },
      aftereffects: {
        modeling: 'Animation',
        lighting: 'Effects',
        texturing: 'Compositing',
        rendering: 'Export',
        deskripsi: 'Deskripsi Teknis'
      },
      traditionalart: {
        modeling: 'Composition',
        lighting: 'Color',
        texturing: 'Technique',
        rendering: 'Finishing',
        deskripsi: 'Deskripsi Teknis'
      }
    };

    // helper: simpan dan ambil dari localStorage
    function getUploads(){ try{ return JSON.parse(localStorage.getItem('portfolio_uploads') || '[]') }catch(e){return []} }
    function saveUploads(arr){ localStorage.setItem('portfolio_uploads', JSON.stringify(arr)) }

    // helper: simpan skill summary per aplikasi
    function getSkillSummary(){ try{ return JSON.parse(localStorage.getItem('skill_summary') || '{}') }catch(e){return {}} }
    function saveSkillSummary(obj){ localStorage.setItem('skill_summary', JSON.stringify(obj)) }

    // UI refs
    const loginBtn = document.getElementById('loginBtn');
    const loginSection = document.getElementById('loginSection');
    const uploadContent = document.getElementById('uploadContent');
    const loginError = document.getElementById('loginError');
    const usernameEl = document.getElementById('username');
    const passwordEl = document.getElementById('password');
    const fileInput = document.getElementById('fileInput');
    const previewWrap = document.getElementById('previewWrap');
    const previewImg = document.getElementById('previewImg');
    const previewVideo = document.getElementById('previewVideo');
    const descEl = document.getElementById('desc');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const aiResult = document.getElementById('aiResult');
    const finalizeBtn = document.getElementById('finalizeBtn');
    const status = document.getElementById('status');
    const appSelect = document.getElementById('appSelect');

    let currentImageData = null; // base64
    let lastAiScores = null;
    let lastAiText = '';
    let editModeId = null;
    const MAX_FILE_SIZE = 15 * 1024 * 1024; // 15 MB
    const ALLOWED_FILE_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'video/mp4'];

    function showStatus(message, type = 'error') {
      status.innerHTML = `<span class="small" style="color:${type === 'error' ? '#f99' : '#9f9'}">${message}</span>`;
    }

    function validateFile(file) {
      if (!file) return false;
      if (!ALLOWED_FILE_TYPES.includes(file.type)) {
        showStatus(`Error: Tipe file tidak didukung. Hanya izinkan: ${ALLOWED_FILE_TYPES.join(', ')}`);
        return false;
      }
      if (file.size > MAX_FILE_SIZE) {
        showStatus(`Error: Ukuran file terlalu besar (Maks: ${MAX_FILE_SIZE / 1024 / 1024} MB).`);
        return false;
      }
      return true;
    }


    // image preview
    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;

      // Reset previews
      if (!validateFile(f)) {
        fileInput.value = ''; // Clear the invalid file
        return;
      }

      previewImg.style.display = 'none';
      previewVideo.style.display = 'none';
      previewVideo.src = '';

      const reader = new FileReader();
      reader.onload = function(ev){
        currentImageData = ev.target.result;
        if (f.type.startsWith('video/')) {
          previewVideo.src = currentImageData;
          previewVideo.style.display = 'block';
        } else {
          previewImg.src = currentImageData;
          previewImg.style.display = 'block';
        }
        previewWrap.style.display = 'block';
      }
      reader.readAsDataURL(f);
      debouncedAutoAnalyze();
    });

    // simple AI text analyzer (keyword-based) - dynamic based on app
    function analyzeText(desc, app){
      const text = (desc||'').toLowerCase();
      // keywords per aspek per app
      const kw = {
        blender: {
          modeling: ['retopo','topology','topologi','retopology','edge loop','quad','subdivision','bevel','sculpt','sculpting','blockout','lowpoly','highpoly','modifier','boolean','extrude','loop cut'],
          lighting: ['hdr','hdri','lighting','light','exposure','key light','rim light','ambient occlusion','ao','shadow','bounce','cycles','eevee','world lighting'],
          texturing: ['pbr','albedo','roughness','metallic','texture','uv','unwrap','bake','normal map','detail','node','shader','principled bsdf','image texture'],
          rendering: ['cycles','eevee','render','samples','denoise','noise','resolution','rendering','filmic','pass','render pass','compositor'],
          deskripsi: ['workflow','pipeline','step','technique','workflow','modifier','nodes','shader','maps','blender','addon']
        },
        zbrush: {
          modeling: ['sculpt','sculpting','dynamesh','zremesher','subdivision','polypaint','masking','morph','deformation','brush','alpha','stencil'],
          lighting: ['light','shadow','matcap','material','render','bpr','zbrush render','lighting setup'],
          texturing: ['polypaint','texture','uv','unwrap','normal map','detail','brush','alpha','stencil','material','surface noise'],
          rendering: ['bpr','render','resolution','anti-aliasing','shadow','matcap','zbrush render','best preview render'],
          deskripsi: ['workflow','pipeline','step','technique','zbrush','dynamesh','polypaint','brush','alpha']
        },
        substance: {
          modeling: [], // substance is texturing
          lighting: [], // minimal
          texturing: ['pbr','albedo','roughness','metallic','height','normal','ao','substance painter','sps','layer','mask','generator','filter','smart material','smart mask','baking','uv','unwrap'],
          rendering: ['render','preview','environment','lighting','hdri'],
          deskripsi: ['workflow','pipeline','step','technique','substance','pbr','material','baking','uv']
        },
        photoshop: {
          modeling: [], // 2d
          lighting: ['lighting','shadow','highlight','dodge','burn','curves','levels','exposure','brightness','contrast'],
          texturing: ['texture','layer','mask','brush','clone','heal','content aware','pattern','gradient','filter','effect','blend mode'],
          rendering: ['render','resolution','export','save for web','jpeg','png','tiff','quality','compression'],
          deskripsi: ['workflow','pipeline','step','technique','photoshop','layer','mask','filter','effect','adjustment']
        },
        illustrator: {
          modeling: [], // vector
          lighting: [], // minimal
          texturing: ['vector','path','pen tool','brush','gradient','pattern','swatch','stroke','fill','effect','filter','blend mode','opacity'],
          rendering: ['export','pdf','svg','eps','ai','resolution','rasterize','artboard'],
          deskripsi: ['workflow','pipeline','step','technique','illustrator','vector','path','pen','brush','effect']
        },
        premiere: {
          modeling: [], // video
          lighting: ['color grading','lut','curves','levels','exposure','brightness','contrast','shadow','highlight'],
          texturing: ['color correction','color grading','lut','secondary color','tracking','mask','keying','green screen','chroma key'],
          rendering: ['export','render','codec','resolution','frame rate','bitrate','h264','prores','timeline','sequence'],
          deskripsi: ['workflow','pipeline','step','technique','premiere','editing','color grading','audio','transition','effect']
        },
        fotogrfi: {
          modeling: [], // photography
          lighting: ['lighting','exposure','iso','aperture','shutter speed','white balance','flash','natural light','studio light','hdr','bracketing'],
          texturing: ['composition','angle','focus','depth of field','sharpness','contrast','saturation','color balance','editing','retouch','dodge','burn'],
          rendering: ['resolution','jpeg','raw','tiff','export','print','web','compression','quality'],
          deskripsi: ['workflow','pipeline','step','technique','photography','camera','lens','lighting','editing','post-processing']
        },
        digitalart: {
          modeling: ['concept','sketch','idea','design','layout','composition'],
          lighting: ['color','palette','hue','saturation','brightness','contrast','tone','shade','highlight','shadow'],
          texturing: ['styling','brush','layer','effect','filter','blend mode','texture','pattern','gradient','opacity'],
          rendering: ['export','resolution','jpeg','png','tiff','quality','compression','save for web','artboard'],
          deskripsi: ['workflow','pipeline','step','technique','digital art','illustration','concept art','design','styling']
        },
        aftereffects: {
          modeling: ['animation','keyframe','motion','timeline','layer','composition','precomp','null object','shape layer'],
          lighting: ['effects','visual effects','vfx','particle','glow','blur','shadow','light','flare','adjustment layer'],
          texturing: ['compositing','mask','tracking','keying','green screen','rotoscoping','matte','alpha','blend mode'],
          rendering: ['export','render','codec','resolution','frame rate','bitrate','quicktime','mp4','after effects','ae'],
          deskripsi: ['workflow','pipeline','step','technique','after effects','motion graphics','visual effects','compositing','animation']
        }
      };
      const appKw = kw[app] || kw.blender; // fallback
      const baseScore = {modeling:4, lighting:4, texturing:4, rendering:4, deskripsi:3}; // baseline
      const maxAdd = 6; // so text-based score up to 10
      const res = {};
      for(const aspect in appKw){
        let cnt = 0;
        appKw[aspect].forEach(k=>{
          if(text.includes(k)) cnt++;
        });
        // score based on count (saturate)
        const score = Math.min(10, baseScore[aspect] + Math.min(maxAdd, cnt*1.8));
        res[aspect] = Number(score.toFixed(2));
      }

      // analysis text (summary) - dynamic per app
      const analysis = [];
      if(text.trim().length === 0) analysis.push('Deskripsi kosong — AI merekomendasikan menuliskan langkah workflow & fitur yang digunakan.');
      else {
        if(res.modeling >= 8) analysis.push(`Deskripsi menunjukkan praktik ${aspect} yang baik untuk ${app}.`);
        if(res.lighting >= 7) analysis.push(`Deskripsi menyebut teknik ${aspect} sehingga AI menganggap perhatian terhadap ${aspect} baik.`);
        if(res.texturing >= 7) analysis.push(`Ada penyebutan teknik ${aspect} sehingga ${aspect} dinilai kuat.`);
        if(res.rendering >= 7) analysis.push(`Penggunaan ${aspect} / setting ${aspect} disebutkan.`);
      }
      return {scores:res, text: analysis.join(' ') || 'Analisis teks singkat: tidak banyak kata kunci teknis.'};
    }

    // simple image analyzer (basic metrics)
    async function analyzeImage(imgDataUrl){
      if (!imgDataUrl) {
        // fallback neutral scores
        return {modeling:6, lighting:6, texturing:6, rendering:6, text:'Tidak ada gambar ter-upload.'};
      }
      // If it's a video, skip analysis and return neutral scores
      if (imgDataUrl.startsWith('data:video')) {
        return {modeling:6, lighting:6, texturing:6, rendering:6, text:'Analisis gambar dilewati untuk file video.'};
      }
      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = function(){
          // draw to canvas scaled down for speed
          const cw = Math.min(300, img.width);
          const ch = Math.round(img.height * (cw / img.width));
          const c = document.createElement('canvas');
          c.width = cw; c.height = ch;
          const ctx = c.getContext('2d');
          ctx.drawImage(img,0,0,cw,ch);
          const data = ctx.getImageData(0,0,cw,ch).data;
          // compute average luminance and edge density
          let lumSum = 0;
          let edgeSum = 0;
          // simple sobel-like approximation for edges: compare with neighbor
          for(let y=0;y<ch;y++){
            for(let x=0;x<cw;x++){
              const i = (y*cw + x)*4;
              const r = data[i], g = data[i+1], b = data[i+2];
              const lum = 0.2126*r + 0.7152*g + 0.0722*b;
              lumSum += lum;
              // neighbor difference
              if(x < cw-1){
                const ni = (y*cw + (x+1))*4;
                const nr = data[ni], ng = data[ni+1], nb = data[ni+2];
                const diff = Math.abs(r-nr)+Math.abs(g-ng)+Math.abs(b-nb);
                edgeSum += diff;
              }
            }
          }
          const pix = cw*ch;
          const avgLum = lumSum / pix; // 0-255
          const avgEdge = edgeSum / pix; // avg diff across neighbors
          // map lum to lighting score: mid-range lum tends to indicate balanced lighting
          let lightingScore = 6;
          if(avgLum < 30) lightingScore = 4; // too dark
          else if(avgLum < 80) lightingScore = 5.5;
          else if(avgLum < 140) lightingScore = 7;
          else if(avgLum < 200) lightingScore = 6.5;
          else lightingScore = 5.5; // too bright

          // map edge to modeling detail: higher edges -> more detail (but noisy increases edge too)
          let modelingScore = Math.min(9.5, Math.max(3.5, (avgEdge / 40) )); // scale approx
          modelingScore = Number((modelingScore).toFixed(2));

          // texturing score: use edge and some lum heuristics
          let texturingScore = (modelingScore*0.6) + (lightingScore*0.4);
          texturingScore = Math.min(9.8, Math.max(3.5, texturingScore));

          // rendering: consider smoothness (low edge + mid lum) -> render quality
          let renderingScore = 7 - Math.min(3, avgEdge/120) + ((avgLum>60 && avgLum<180)?0.6:0);
          renderingScore = Math.min(9.5, Math.max(3.5, renderingScore));

          resolve({
            modeling: Number(modelingScore.toFixed(2)),
            lighting: Number(lightingScore.toFixed(2)),
            texturing: Number(texturingScore.toFixed(2)),
            rendering: Number(renderingScore.toFixed(2)),
            text: `Analisis gambar: avgLum=${Math.round(avgLum)}, avgEdge=${Math.round(avgEdge)}`
          });
        };
        img.onerror = function(){ resolve({modeling:6,lighting:6,texturing:6,rendering:6,text:'Gagal memuat gambar.'});}
        img.src = imgDataUrl;
      });
    }

    // combine text-analysis and image-analysis into AI scores
    async function runAiAnalysis(desc, imgDataUrl, app){
      const textRes = analyzeText(desc, app);
      const imgRes = await analyzeImage(imgDataUrl);
      // combine: text influences deskripsi strongly, image influences visual aspects strongly
      const combined = {
        modeling: Number(((imgRes.modeling*0.75) + (textRes.scores.modeling*0.25)).toFixed(2)),
        lighting: Number(((imgRes.lighting*0.75) + (textRes.scores.lighting*0.25)).toFixed(2)),
        texturing: Number(((imgRes.texturing*0.75) + (textRes.scores.texturing*0.25)).toFixed(2)),
        rendering: Number(((imgRes.rendering*0.75) + (textRes.scores.rendering*0.25)).toFixed(2)),
        deskripsi: Number((textRes.scores.deskripsi).toFixed(2)),
        textSummary: (textRes.text + ' ' + imgRes.text).trim()
      };
      return combined;
    }

    // Function to update labels based on selected app
    function updateLabels(app) {
      const labels = APP_LABELS[app] || APP_LABELS.blender;
      document.getElementById('label_modeling').textContent = labels.modeling;
      document.getElementById('label_lighting').textContent = labels.lighting;
      document.getElementById('label_texturing').textContent = labels.texturing;
      document.getElementById('label_rendering').textContent = labels.rendering;
      document.getElementById('label_deskripsi').textContent = labels.deskripsi;
    }

    // Update labels on app change
    appSelect.addEventListener('change', () => {
      updateLabels(appSelect.value);
    });

    // Initialize labels on load
    updateLabels(appSelect.value);

    // compute final and store
    finalizeBtn.addEventListener('click', async ()=>{
      if(!currentImageData){
        showStatus('Silakan upload gambar terlebih dulu.');
        return;
      }
      if (descEl.value.trim().length < 10) {
        showStatus('Deskripsi proyek terlalu pendek. Mohon jelaskan lebih detail.');
        return;
      }
      // ensure AI run
      if(!lastAiScores){
        showStatus('Klik "Analisis AI" dulu sebelum finalize.');
        return;
      }
      // collect user scores
      const userScores = {
        modeling: Number(document.getElementById('u_modeling').value) || 0,
        lighting: Number(document.getElementById('u_lighting').value) || 0,
        texturing: Number(document.getElementById('u_texturing').value) || 0,
        rendering: Number(document.getElementById('u_rendering').value) || 0,
        deskripsi: Number(document.getElementById('u_deskripsi').value) || 0
      };

      // final per-aspect = (user*0.5 + ai*0.5)
      const finalScores = {};
      for(const k in userScores){
        finalScores[k] = Number(((userScores[k]*0.5) + (lastAiScores[k]*0.5)).toFixed(2));
      }

      // compute total skill percent using weights (0-10 -> percent)
      let total = 0;
      for(const k in finalScores){
        const weight = ASPECT_WEIGHTS[k] || 0;
        total += (finalScores[k] * (weight/100)) * 10; // because finalScores in 0-10 -> *10 to get percent
      }
      // Bug Fix: Ensure totalPercent is a valid number before saving
      let totalPercent = Number(total.toFixed(2)); // 0-100
      if (isNaN(totalPercent)) {
        console.error("Calculation error: totalPercent is NaN. Defaulting to 0.", { userScores, lastAiScores, finalScores });
        totalPercent = 0;
      }

      // build upload object
      const obj = {
        id: 'upl_'+Date.now(),
        app: appSelect.value, // e.g., 'blender'
        imageData: currentImageData,
        description: descEl.value,
        userScores,
        aiScores: lastAiScores,
        finalScores,
        totalPercent,
        aiText: lastAiText,
        timestamp: new Date().toISOString()
      };

      // store in uploads (check for edit mode)
      const uploads = getUploads();
      if (editModeId) {
        const index = uploads.findIndex(u => u.id === editModeId);
        if (index !== -1) {
          // Preserve original ID and timestamp when editing
          uploads[index] = { ...obj, id: editModeId, timestamp: uploads[index].timestamp };
        } else {
          uploads.unshift(obj); // Fallback: add as new if ID not found
        }
      } else {
        uploads.unshift(obj); // add newest front
      }
      saveUploads(uploads);

      // Hapus perhitungan summary dari sini. Biarkan index.html yang menghitung.
      status.innerHTML = `<span class="success">${editModeId ? 'Berhasil diperbarui!' : 'Berhasil di-upload!'} Persentase skill akan diperbarui di halaman utama.</span>`;

      // reset-ish
      lastAiScores = null;
      lastAiText = '';
      // redirect to target page
      setTimeout(()=>{
        // Redirect ke halaman utama untuk melihat pembaruan skill
        const target = `index.html#karya=${editModeId || obj.id}`;
        window.location.href = target;
      },800);
    });

    // Bug Fix: Reset AI analysis if description or file changes
    function resetAiAnalysisState() {
      if (lastAiScores) {
        lastAiScores = null;
        lastAiText = '';
        aiResult.style.display = 'block';
        aiResult.innerHTML = '<span style="color:#f99">Deskripsi atau file berubah. Mohon klik "Analisis AI" lagi.</span>';
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = 'Analisis AI';
      }
    }

    descEl.addEventListener('input', debouncedAutoAnalyze);
    fileInput.addEventListener('change', resetAiAnalysisState);
    appSelect.addEventListener('change', resetAiAnalysisState);

    // login functionality
    loginBtn.addEventListener('click', ()=>{
      const username = usernameEl.value.trim();
      const password = passwordEl.value.trim();
      // Pengecekan kredensial langsung (seperti semula)
      if(username === "MELABAR157" && password === "06-10-08"){
        loginSection.style.opacity = '0';
        setTimeout(() => {
          loginSection.style.display = 'none';
          uploadContent.style.display = 'block';
          uploadContent.classList.add('show');
        }, 500);
        loginError.style.display = 'none';
      } else {
        loginError.textContent = 'sandi anda salah';
        loginError.style.display = 'block';
        loginError.classList.add('message');
      }
    });

    // drag and drop functionality
    const dropZone = document.querySelector('.drop-zone');
    const dragOverlay = document.getElementById('dragOverlay');
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        if (validateFile(files[0])) {
          fileInput.files = files;
          fileInput.dispatchEvent(new Event('change'));
        }
      }
    });
    // Global drag-drop overlay
    window.addEventListener('dragenter', (e) => {
      dragOverlay.classList.add('visible');
    });
    // Use a counter to deal with child elements firing dragleave
    let dragCounter = 0;
    window.addEventListener('dragenter', () => dragCounter++);
    window.addEventListener('dragleave', () => {
      dragCounter--;
      if (dragCounter === 0) {
        dragOverlay.classList.remove('visible');
      }
    });
    window.addEventListener('drop', () => { dragCounter = 0; dragOverlay.classList.remove('visible'); });

    // loading spinner for AI analysis
    analyzeBtn.addEventListener('click', async ()=>{
      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = '<span class="spinner"></span> Menganalisis...';
      aiResult.style.display='block';
      aiResult.textContent = 'AI sedang menganalisis...';
      const desc = descEl.value;
      const app = appSelect.value;
      const ai = await runAiAnalysis(desc, currentImageData, app);
      analyzeBtn.disabled = false; analyzeBtn.innerHTML = 'Analisis AI';
      lastAiScores = ai;
      lastAiText = ai.textSummary;
      const labels = APP_LABELS[app] || APP_LABELS.blender;
      aiResult.innerHTML = `<strong>Hasil AI (skor 0–10):</strong>
        <table>
          <tr><th>Aspek</th><th>Skor AI</th></tr>
          <tr><td>${labels.modeling}</td><td>${ai.modeling}</td></tr>
          <tr><td>${labels.lighting}</td><td>${ai.lighting}</td></tr>
          <tr><td>${labels.texturing}</td><td>${ai.texturing}</td></tr>
          <tr><td>${labels.rendering}</td><td>${ai.rendering}</td></tr>
          <tr><td>${labels.deskripsi}</td><td>${ai.deskripsi}</td></tr>
        </table>
        <p style="margin-top:8px"><strong>Ringkasan AI:</strong> ${ai.textSummary}</p>
      `;
      analyzeBtn.disabled = false;
      analyzeBtn.innerHTML = 'Analisis AI';
    });

    // Debounce function for auto-analysis
    let debounceTimeout;
    function debouncedAutoAnalyze() {
      resetAiAnalysisState();
      clearTimeout(debounceTimeout);
      if (currentImageData && descEl.value.trim().length > 10) {
        debounceTimeout = setTimeout(() => {
          if (currentImageData && descEl.value.trim().length > 10) { // Double check
            analyzeBtn.click();
          }
        }, 1500); // Wait 1.5s after user stops typing
      }
    }

    // tooltips for inputs
    const inputs = document.querySelectorAll('input, textarea');
    inputs.forEach(input => {
      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip';
      tooltip.innerHTML = `<span class="tooltiptext">${input.placeholder || 'Masukkan nilai'}</span>`;
      input.parentNode.appendChild(tooltip);
    });

    // success message animation
    const statusEl = document.getElementById('status');
    const observer = new MutationObserver(() => {
      if (statusEl.innerHTML.includes('Berhasil')) {
        statusEl.classList.add('message');
      }
    });
    observer.observe(statusEl, { childList: true });

    // load existing for debugging
    (function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const workIdToEdit = urlParams.get('edit');
      if (workIdToEdit) {
        const uploads = getUploads();
        const workToEdit = uploads.find(u => u.id === workIdToEdit);
        if (workToEdit) {
          editModeId = workIdToEdit;
          // Populate form with existing data
          document.querySelector('h1').textContent = 'Edit Proyek';
          appSelect.value = workToEdit.app;
          descEl.value = workToEdit.description;
          currentImageData = workToEdit.imageData;
          if (currentImageData.startsWith('data:video')) {
            previewVideo.src = currentImageData;
            previewVideo.style.display = 'block';
          } else {
            previewImg.src = currentImageData;
            previewImg.style.display = 'block';
          }
          previewWrap.style.display = 'block';
          // Populate manual scores
          if (workToEdit.userScores) {
            for (const key in workToEdit.userScores) {
              const input = document.getElementById(`u_${key}`);
              if (input) input.value = workToEdit.userScores[key];
            }
          }
          finalizeBtn.textContent = 'Update Karya';
          updateLabels(workToEdit.app); // Update labels for the correct app
        }
      }
    })();
  </script>
</body>
</html>
